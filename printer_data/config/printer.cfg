#[include shell_command.cfg]
#[include moonraker_obico_macros.cfg]
########################### FLSUN SUPER RACER ###########################
# This file contains common pin mappings for MKS Robin Nano V3
# boards. To use this config, the firmware should be compiled for the
# stm32f407. When running "make menuconfig", select the 48KiB
# bootloader, and enable "USB for communication".

# The "make flash" command does not work on the MKS Robin. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "Robin_nano_v3.bin" on an SD card and then restart the
# MKS Robin with that SD card.

# See docs/Config_Reference.md for a description of parameters.

########################################
# MCU
########################################

[mcu]
# Run ls /dev/serial/by-id/* on your Raspberry Pi to get which serial to use.
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_3F0043000550304B57303220-if00
baud: 250000
restart_method: command

[mcu EBBCan]
canbus_uuid: 28e7eff55bcd

########################################
# Printer / Misc
########################################

[printer]
kinematics: delta
max_velocity: 300
max_accel: 2500
#max_accel_to_decel: 2000
max_z_velocity: 150
max_z_accel: 1500
minimum_z_position: -25
square_corner_velocity: 5.0
print_radius: 130

########################################
# A (X-Stepper) Configuration
########################################

# Front Left Tower at 210 Degrees
[stepper_a]
step_pin: PE3
dir_pin: PE2
enable_pin: !PE4
microsteps: 128
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PA15 # X_MAX
homing_speed: 50
homing_retract_dist: 5.0
homing_retract_speed: 10 
second_homing_speed: 3.0
step_pulse_duration: 0.000000100

[tmc2209 stepper_a]
uart_pin: PD5
interpolate: true
run_current: 0.90 # 1.100
hold_current: 0.5 # 0.636
sense_resistor: 0.110
stealthchop_threshold: 999999 

########################################
# B (Y-Stepper)  Configuration
########################################

# Front Right Tower at 330 Degrees
[stepper_b]
step_pin: PE0
dir_pin: PB9
enable_pin: !PE1
microsteps: 128
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PD2 # Y_MAX
homing_speed: 50
homing_retract_dist: 5.0
homing_retract_speed: 10 
second_homing_speed: 3.0
step_pulse_duration: 0.000000100

[tmc2209 stepper_b]
uart_pin: PD7
interpolate: true
run_current: 0.90 # 1.100
hold_current: 0.5 # 0.636
sense_resistor: 0.110
stealthchop_threshold: 999999 

########################################
# C (Z-Stepper)  Configuration
########################################

# Rear Center Tower at 90 Degrees
[stepper_c]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB8
microsteps: 128
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: ^PC4 # Z_MAX
homing_speed: 50
homing_retract_dist: 5.0
homing_retract_speed: 10 
second_homing_speed: 3.0
step_pulse_duration: 0.000000100

[tmc2209 stepper_c]
uart_pin: PD4
interpolate: true
run_current: 0.90 # 1.100
hold_current: 0.5 # 0.636
sense_resistor: 0.110
stealthchop_threshold: 999999 

########################################
# Extruder Configuration
########################################

[extruder]
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
heater_pin: EBBCan: PB13
#microsteps: 32                          # Value for My test motor from StepperOnline
microsteps: 16                          # Value recommended by The Orbiter Project for the LDO
#gear_ratio:                             # NOT used as the Orbiter v2.0 has no gear box
rotation_distance: 4.637                # Value recommended by The Orbiter Project for the LDO
#full_steps_per_rotation: 400            # Value for My test motor from StepperOnline
full_steps_per_rotation: 200            # Value recommended by The Orbiter Project for the LDO
nozzle_diameter: 0.400
filament_diameter: 1.750
#max_extrude_cross_section:
instantaneous_corner_velocity: 2.5
max_extrude_only_distance: 500          # Value recommended by The Orbiter Project
max_extrude_only_velocity: 120          # Value recommended by The Orbiter Project
#max_extrude_only_accel:
pressure_advance: 0.08
pressure_advance_smooth_time: 0.001
#sensor_type: PT1000                     # When running PT1000 off of the thermister pins
#sensor_pin: EBBCan: PA3                 # When running PT1000 off of the thermister pins
sensor_type: MAX31865                   # When running PT1000 off of the amplifier pins
sensor_pin: EBBCan: PA4                 # For two wire PT1000 set dip switches to ON, ON, OFF, ON
spi_bus: spi1
rtd_nominal_r: 1000                     # Set to 100 for PT100 or 1000 for PT1000
rtd_reference_r: 4300                   # Set to 430 for PT100 or 4300 for PT1000
rtd_num_of_wires: 2                     # 2, 3 or 4 wires. Set accordingly
#min_extrude_temp: 0                     # Value for My test motor from StepperOnline
min_extrude_temp: 170
min_temp: -100                          # Changed from 0 for testing PT1000 
max_temp: 300
step_pulse_duration: 0.000000100

[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: true                       # Value recommended by The Orbiter Project
#run_current: 0.3535                     # Value for My test motor from StepperOnline
run_current: 0.85                       # Value recommended by The Orbiter Project for the LDO
#hold_current: 0.1                       # Value for My test motor from StepperOnline
hold_current: 0.100                     # Value recommended by The Orbiter Project for the LDO
sense_resistor: 0.11                    # Value recommended by The Orbiter Project
stealthchop_threshold: 0                # Value recommended by The Orbiter Project
driver_TBL: 0                           # Value recommended by The Orbiter Project
driver_HEND: 6                          # Value recommended by The Orbiter Project
driver_HSTRT: 7                         # Value recommended by The Orbiter Project
driver_TOFF: 4                          # Value recommended by The Orbiter Project

########################################
# Delta Calibration / Bed Mesh
########################################

[delta_calibrate]
radius: 130
speed: 100
horizontal_move_z: 30

[bed_mesh]
speed: 150
horizontal_move_z: 30
mesh_radius: 125
mesh_origin: 0,0
round_probe_count: 17
#   Default is 5.
#fade_start: 1.0
#fade_end: 30.0
#fade_target:
#split_delta_z: .025
move_check_distance: 3.0
mesh_pps: 4, 4
algorithm: bicubic
bicubic_tension: .1
#relative_reference_index:
#faulty_region_1_min:
#faulty_region_1_max:

[delayed_gcode bed_mesh_init]
initial_duration: .01
gcode:
  BED_MESH_PROFILE LOAD=default

########################################
# End Stop
########################################

# Make sure to run the following commands in this order.
# endstop_phase_calibrate stepper=stepper_a
# endstop_phase_calibrate stepper=stepper_b
# endstop_phase_calibrate stepper=stepper_c
# DELTA_CALIBRATE 
# G29 (Home)
# BED_MESH_CALIBRATE

# Enables the ENDSTOP_PHASE_CALIBRATE command.
[endstop_phase]

[endstop_phase stepper_a]
#endstop_accuracy:
#trigger_phase:
endstop_align_zero: false

[endstop_phase stepper_b]
#endstop_accuracy:
#trigger_phase:
endstop_align_zero: false

[endstop_phase stepper_c]
#endstop_accuracy:
#trigger_phase:
endstop_align_zero: false 

########################################
# Filament Sensor
########################################


[filament_switch_sensor switch_sensor]
switch_pin: ^PE6
pause_on_runout: False
runout_gcode:
    PAUSE
    M117 Filament switch runout
insert_gcode:
    M117 Filament switch inserted

[filament_motion_sensor encoder_sensor]
switch_pin: ^PA4
detection_length: 8.64
extruder: extruder
runout_gcode:
    PAUSE
    M117 Filament encoder runout
insert_gcode:
    M117 Filament encoder inserted

#[filament_switch_sensor filament_runout_sensor]
#switch_pin: PA4
#pause_on_runout: true
#runout_gcode: M600
#insert_gcode:
#event_delay: 3.0
#pause_delay: 0.5

########################################
# Bed Configuration
########################################

[heater_bed]
heater_pin: PA0
sensor_type: Generic 3950
sensor_pin: PC0
smooth_time: 1.0
max_power: 0.80
min_temp: 0
max_temp: 140 # 130

########################################
# Heating
########################################

[verify_heater heater_bed]
#max_error: 120
check_gain_time: 30
hysteresis: 5
heating_gain: 2


[verify_heater extruder]
max_error: 500
check_gain_time: 30
hysteresis: 20
heating_gain: 2

########################################
# Tool to disable heaters when homing or probing an axis.
########################################

[homing_heaters]
heaters: extruder

########################################
# Fan/Other Configuration
########################################

# Heatsink Fan FAN1 on EBB36
[heater_fan hotend_fan] 
pin: EBBCan: PA0
max_power: 1.0
kick_start_time: 0.500
heater: extruder
heater_temp: 50.0
fan_speed: 1.0
shutdown_speed: 1.0
#hardware_pwm: true

[multi_pin my_fan]
pins=PC14,PB1

# Part Cooling Fan on Robin Nano
[fan]       
pin: multi_pin:my_fan
#pin: PC14
#hardware_pwm: True
#max_power: 1.0
#kick_start_time: 0.500
#cycle_time: 0.0001

[fan_generic filter_fans]
pin: PB0

# Chamber Fan
#[output_pin chamber_fan]
# connected to Fan2 on Duet
#pin: PA0
#pwm: True
#hardware_pwm: True
#cycle_time: 0.0001

# Controller Board Fan
#[controller_fan driver_fan]
#pin: FAN
#hardware_pwm: True
#kick_start_time: 0.500
#max_power: 0.3
#idle_speed: 0.3
#cycle_time: 0.05

[neopixel neo]
pin: EBBCan: PD3
chain_count: 9
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0

[neopixel robin-neo]
pin: PA8
chain_count: 87
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0

########################################
# Temperature Sensors
########################################

[temperature_sensor rpi_temperature]
sensor_type: temperature_host
min_temp: 0
max_temp: 80

[temperature_sensor mcu_temperature]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 80

[temperature_sensor EBBCan]
sensor_type: temperature_mcu
sensor_mcu: EBBCan
min_temp: 0
max_temp: 100

########################################
# Probe Configuration
########################################

[probe]
pin: ^!EBBCan:PB6
x_offset: 0.601
y_offset: 0.257
speed: 10
lift_speed: 50
sample_retract_dist: 6
samples: 3
samples_result: average
samples_tolerance: 0.02
samples_tolerance_retries: 5

########################################
# ADXL345
########################################

[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345
probe_points: 0,0,20

########################################
# Servos
########################################

# source: https://github.com/FHeilmann/klipper_config/blob/master/klipper_configs/klicky.cfg
#[servo probe_servo]
#pin: P2.0
#maximum_servo_angle: 180
#minimum_pulse_width: 0.001
#maximum_pulse_width: 0.0025

########################################
# Optional G-code Features
########################################

[save_variables]
filename: ~/printer_variables.cfg

[force_move]
enable_force_move: True

[pause_resume]
#recover_velocity: 50.

[firmware_retraction]
retract_length: 0.4
retract_speed: 120
unretract_extra_length: .15
unretract_speed: 60

[respond]
#default_type: command
#   Sets the default prefix of the "M118" and "RESPOND" output to one
#   of the following:
#       echo: "echo: " (This is the default)
#       command: "// "
#       error: "!! "
#default_prefix: echo:
#   Directly sets the default prefix. If present, this value will
#   override the "default_type".

# Enable object exclusion
[exclude_object]

# Enable arcs support
[gcode_arcs]
resolution: 0.1

########################################
# Idle Time-out
########################################

# Time in seconds (300 = 5 minutes - 1800 = 30 minutes)
[idle_timeout]
timeout: 1800
#gcode:
#    M117 Idle timeout reached...
#    {action_respond_info("Entering idle mode")}
#    {% if printer.toolhead.homed_axes == 'xyz' %}
#        G91                 ; set relative positioning
#        G0 Z10 F60          ; rapid move, raise Z
#        G90                 ; set absolute positioning
#        G0 X0 Y0 F240       ; rapid move center
#    {% endif %
#    M104 S0                 ; extruder temperature 0 = off
#    M140 S0                 ; bed temperature (fast) 0 = off
#    M84                     ; motors off

########################################
# EXP1 / EXP2 (display) pins
########################################

# See the sample-lcd.cfg file for definitions of common LCD displays.
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC5,  EXP1_3=PD13, EXP1_5=PE14, EXP1_7=PD11, EXP1_9=<GND>,
    EXP1_2=PE13, EXP1_4=PC6,  EXP1_6=PE15, EXP1_8=PD10, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE8, EXP2_5=PE11, EXP2_7=PE12,  EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PE10, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<3.3v>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp1"


########################################
# Fluidd
########################################
[include fluidd.cfg]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

########################################
# Mainsail
########################################

[include mainsail.cfg]

########################################
# Macro's
########################################

[gcode_macro Unload_Filament]
gcode:
 M83                                    # Put the extruder into relative mode
 G92 E0.0                               # Reset the extruder so that it thinks it is at position zero
 G1 E-120 F1200                         # Pull filament from nozzle 120mm at a speed of 1200mm/minute
 G92 E0.0                               # Reset the extruder again
 M82                                    # Put the extruder back into absolute mode.

[gcode_macro Load_Filament]
gcode:
 M83                                    # Put the extruder into relative mode
 G92 E0.0                               # Reset the extruder so that it thinks it is at position zero
 G1 E100 F600                           # Push filament to nozzle 100mm at a speed of 600mm/minute
 G92 E0.0                               # Reset the extruder again
 M82                                    # Put the extruder back into absolute mode.

[gcode_macro Purge_Nozzle]
gcode:
 M83                                    # Put the extruder into relative mode
 G92 E0.0                               # Reset the extruder so that it thinks it is at position zero
 G1 E5 F600                             # Push filament from nozzle 5mm at a speed of 600mm/minute
 G92 E0.0                               # Reset the extruder again
 M82                                    # Put the extruder back into absolute mode.

#[include macros/*.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 19.800
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 29.953
#*# pid_ki = 1.457
#*# pid_kd = 153.887
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 45.309
#*# pid_ki = 1.007
#*# pid_kd = 509.724
#*#
#*# [printer]
#*# delta_radius = 151.958749
#*#
#*# [stepper_a]
#*# arm_length = 314.790902
#*# position_endstop = 326.750394
#*# angle = 210.006713
#*#
#*# [stepper_b]
#*# arm_length = 315.254962
#*# position_endstop = 326.566110
#*# angle = 330.016160
#*#
#*# [stepper_c]
#*# arm_length = 314.726031
#*# position_endstop = 327.857930
#*# angle = 90.000000
#*#
#*# [input_shaper]
#*# shaper_type_x = 3hump_ei
#*# shaper_freq_x = 80.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 43.8
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557, -0.161557
#*# 	  -0.068477, -0.068477, -0.068477, -0.068477, -0.068477, -0.068477, -0.056900, -0.093057, -0.146493, -0.144308, -0.169900, -0.178953, -0.178953, -0.178953, -0.178953, -0.178953, -0.178953
#*# 	  0.044854, 0.044854, 0.044854, 0.044854, 0.015989, -0.062252, -0.074022, -0.085270, -0.121188, -0.103107, -0.149891, -0.136381, -0.133699, -0.074797, -0.074797, -0.074797, -0.074797
#*# 	  0.056972, 0.056972, 0.056972, 0.015823, 0.031918, -0.037533, -0.042106, -0.067076, -0.108759, -0.090601, -0.124289, -0.128971, -0.151397, -0.094707, -0.020484, -0.020484, -0.020484
#*# 	  0.016815, 0.016815, 0.016815, -0.021639, 0.000692, -0.027950, -0.045866, -0.068327, -0.092115, -0.079496, -0.089043, -0.094194, -0.099148, -0.051740, -0.018250, -0.018250, -0.018250
#*# 	  0.003566, 0.003566, 0.040560, 0.024440, 0.011575, -0.020639, -0.023939, -0.041772, -0.067931, -0.075431, -0.106722, -0.107112, -0.096218, -0.079084, -0.025285, 0.044407, 0.044407
#*# 	  -0.005883, -0.005883, 0.009128, 0.000294, 0.014750, -0.010552, -0.015920, -0.043382, -0.052682, -0.088586, -0.070123, -0.061789, -0.049582, -0.009939, 0.019946, 0.042648, 0.042648
#*# 	  0.002901, 0.002901, 0.015845, 0.034937, 0.006930, 0.006156, -0.004791, -0.034205, -0.044200, -0.062898, -0.060805, -0.092724, -0.048341, -0.032989, -0.023447, 0.011995, 0.011995
#*# 	  -0.028886, -0.039189, -0.039459, -0.003432, -0.026230, -0.020257, -0.032412, -0.048075, -0.045746, -0.058392, -0.050750, -0.071661, -0.061596, -0.025849, -0.013736, 0.021887, 0.057897
#*# 	  -0.039127, -0.039127, -0.045844, -0.018215, -0.023408, -0.011066, -0.032203, -0.036939, -0.049713, -0.069045, -0.044564, -0.086892, -0.064401, -0.066717, -0.049784, -0.047112, -0.047112
#*# 	  -0.093363, -0.093363, -0.065323, -0.027785, -0.074331, -0.029254, -0.038080, -0.052548, -0.030711, -0.072228, -0.063979, -0.114166, -0.077422, -0.064595, -0.075007, -0.046481, -0.046481
#*# 	  -0.124033, -0.124033, -0.084309, -0.052287, -0.075240, -0.051436, -0.054791, -0.071164, -0.063882, -0.091158, -0.089575, -0.143744, -0.130820, -0.121076, -0.125599, -0.082112, -0.082112
#*# 	  -0.129456, -0.129456, -0.129456, -0.090955, -0.093488, -0.063167, -0.083431, -0.091425, -0.076556, -0.126251, -0.120779, -0.182936, -0.136086, -0.147472, -0.131972, -0.131972, -0.131972
#*# 	  -0.118939, -0.118939, -0.118939, -0.083276, -0.104038, -0.075501, -0.092444, -0.106823, -0.107009, -0.125473, -0.123832, -0.181962, -0.192082, -0.188463, -0.168967, -0.168967, -0.168967
#*# 	  -0.054348, -0.054348, -0.054348, -0.054348, -0.097973, -0.087318, -0.109494, -0.111811, -0.107245, -0.147118, -0.132541, -0.180472, -0.170330, -0.179395, -0.179395, -0.179395, -0.179395
#*# 	  -0.083353, -0.083353, -0.083353, -0.083353, -0.083353, -0.083353, -0.084145, -0.083742, -0.086640, -0.136188, -0.152530, -0.175540, -0.175540, -0.175540, -0.175540, -0.175540, -0.175540
#*# 	  -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669, -0.031669
#*# x_count = 17
#*# y_count = 17
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.1
#*# min_x = -124.96
#*# max_x = 124.96
#*# min_y = -124.96
#*# max_y = 124.96000000000002
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 191/512
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 110/512
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 475/512
#*#
#*# [delta_calibrate]
#*# height0 = 0.0
#*# height0_pos = 209241.000,208843.000,209767.000
#*# height1 = 0.0
#*# height1_pos = 254624.000,254049.000,185585.000
#*# height2 = 0.0
#*# height2_pos = 204502.000,280122.000,205074.000
#*# height3 = 0.0
#*# height3_pos = 185864.000,246202.000,247377.000
#*# height4 = 0.0
#*# height4_pos = 203002.000,202550.000,258144.000
#*# height5 = 0.0
#*# height5_pos = 240367.000,186987.000,240768.000
#*# height6 = 0.0
#*# height6_pos = 268698.000,203366.000,204204.000
#*# distance0 = 64.87
#*# distance0_pos1 = 210287.480,212045.914,212982.456
#*# distance0_pos2 = 193771.059,229789.433,230992.059
#*# distance1 = 64.89
#*# distance1_pos1 = 211090.050,210472.092,213779.940
#*# distance1_pos2 = 205434.591,204641.177,245331.712
#*# distance2 = 64.97999999999999
#*# distance2_pos1 = 212686.295,209698.554,212982.456
#*# distance2_pos2 = 231010.794,193389.435,230992.059
#*# distance3 = 65.05
#*# distance3_pos1 = 213479.888,210488.565,211398.230
#*# distance3_pos2 = 245327.789,204887.714,205646.177
#*# distance4 = 64.86
#*# distance4_pos1 = 212666.341,212062.533,210611.391
#*# distance4_pos2 = 230666.873,230074.911,194205.815
#*# distance5 = 64.81
#*# distance5_pos1 = 211070.277,212846.436,211398.230
#*# distance5_pos2 = 205138.924,244143.520,205646.177
#*# distance6 = 64.9
#*# distance6_pos1 = 195026.337,226079.937,229859.031
#*# distance6_pos2 = 206649.069,203569.107,243946.744
#*# distance7 = 65.0
#*# distance7_pos1 = 206751.606,203686.241,241215.732
#*# distance7_pos2 = 231513.123,193806.706,228854.788
#*# distance8 = 64.91
#*# distance8_pos1 = 229843.719,194628.799,227240.457
#*# distance8_pos2 = 243914.921,206086.161,204558.907
#*# distance9 = 64.85
#*# distance9_pos1 = 241153.957,206188.817,204668.844
#*# distance9_pos2 = 228511.984,230570.060,194617.780
#*# distance10 = 64.88000000000001
#*# distance10_pos1 = 226895.508,228931.651,195444.341
#*# distance10_pos2 = 204054.475,242761.968,206851.185
#*# distance11 = 64.88
#*# distance11_pos1 = 204174.587,240056.966,206962.507
#*# distance11_pos2 = 194194.594,227671.201,231500.193
